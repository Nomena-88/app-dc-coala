<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Application DC - Prototype Coala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family: Arial, sans-serif; margin: 0; background:#f4f4f4;}
    header {background:#003366; color:white; padding:1rem; text-align:center;}
    .container {max-width: 900px; margin:2rem auto; background:white; padding:1rem; border-radius:5px;}
    h2 {color:#003366;}
    input, button {margin:0.5rem 0; padding:0.5rem;}
    table {width:100%; border-collapse:collapse; margin-top:1rem;}
    th, td {border:1px solid #ccc; padding:0.5rem; text-align:center;}
    th {background:#003366; color:white;}
    .hidden {display:none;}
    .btn {background:#003366; color:white; border:none; cursor:pointer; border-radius:3px;}
    .btn:hover {background:#0055aa;}
  </style>
</head>
<body>
  <header>
    <h1>Application - D√©claration DC (Export Sage Coala)</h1>
  </header>

  <div class="container" id="loginSection">
    <h2>Connexion</h2>
    <input type="text" id="username" placeholder="Identifiant"><br>
    <input type="password" id="password" placeholder="Mot de passe"><br>
    <button class="btn" onclick="login()">Se connecter</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div class="container hidden" id="appSection">
    <h2>Import du grand livre (Export Sage Coala)</h2>
    <p><b>Format attendu CSV :</b> Date,Compte,Tiers,NIF,Libelle,Debit,Credit</p>
    <input type="file" id="csvFile" accept=".csv"><br>
    <button class="btn" onclick="processFile()">Importer et calculer</button>
    <div id="results" class="hidden">
      <h2>Tableau de d√©claration (Canevas DC)</h2>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Fournisseur (Tiers)</th>
            <th>NIF</th>
            <th>Total HT (D√©bit - Cr√©dit)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn" onclick="exportCSV()">Exporter en CSV</button>
      <button class="btn" onclick="exportPDF()">Exporter en PDF</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // üîê Connexion fictive
    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (user === "admin" && pass === "dc2025") {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appSection").classList.remove("hidden");
      } else {
        document.getElementById("loginError").textContent = "Identifiants invalides.";
      }
    }

    // üìù Lecture du fichier CSV
    function processFile() {
      const file = document.getElementById("csvFile").files[0];
      if (!file) { alert("Veuillez importer un fichier CSV export√© de Coala."); return; }

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split("\n").map(l => l.trim()).filter(l => l.length);
        const header = lines[0].split(",");
        
        // On attend les colonnes : Date,Compte,Tiers,NIF,Libelle,Debit,Credit
        const idxTiers = header.findIndex(h => h.toLowerCase().includes("tiers"));
        const idxNif   = header.findIndex(h => h.toLowerCase().includes("nif"));
        const idxDebit = header.findIndex(h => h.toLowerCase().includes("debit"));
        const idxCredit= header.findIndex(h => h.toLowerCase().includes("credit"));

        if (idxTiers === -1 || idxNif === -1 || idxDebit === -1 || idxCredit === -1) {
          alert("Le fichier CSV ne contient pas les colonnes attendues (Tiers, NIF, D√©bit, Cr√©dit).");
          return;
        }

        const data = {};
        lines.slice(1).forEach(line => {
          const cols = line.split(",");
          if (cols.length < header.length) return; // ignore lignes vides
          const tiers = cols[idxTiers].trim() || "Inconnu";
          const nif   = cols[idxNif].trim()   || "-";
          const debit = parseFloat(cols[idxDebit].replace(",", ".")) || 0;
          const credit= parseFloat(cols[idxCredit].replace(",", ".")) || 0;

          const key = tiers + "|" + nif;
          if (!data[key]) data[key] = { fournisseur: tiers, nif, total: 0 };
          data[key].total += debit - credit; // ‚öñ Somme D√©bit - Cr√©dit
        });

        renderTable(data);
      };
      reader.readAsText(file);
    }

    // üìä Affichage du tableau
    function renderTable(data) {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = "";
      Object.values(data).forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.fournisseur}</td>
          <td>${row.nif}</td>
          <td>${row.total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("results").classList.remove("hidden");
    }

    // üíæ Export CSV
    function exportCSV() {
      let csv = "Fournisseur,NIF,TotalHT\n";
      const rows = document.querySelectorAll("#resultsTable tbody tr");
      rows.forEach(r => {
        const cols = r.querySelectorAll("td");
        csv += Array.from(cols).map(c => c.innerText).join(",") + "\n";
      });
      const blob = new Blob([csv], { type:"text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "declaration_DC.csv";
      a.click();
    }

    // üìÑ Export PDF
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("D√©claration DC - R√©sum√©", 10, 10);
      let y = 30;
      const rows = document.querySelectorAll("#resultsTable tbody tr");
      doc.text("Fournisseur | NIF | TotalHT", 10, 20);
      rows.forEach(r => {
        const cols = r.querySelectorAll("td");
        const line = Array.from(cols).map(c => c.innerText).join(" | ");
        doc.text(line, 10, y);
        y += 10;
      });
      doc.save("declaration_DC.pdf");
    }
  </script>
</body>
</html>
