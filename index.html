<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Application DC — Gestion Tiers & Utilisateurs</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body { background: #f4f6fb; transition: background 0.3s, color 0.3s; }
  body.dark-mode { background: #1e1e2f; color: #ddd; }
  .card { border-radius: 12px; }
  header.navbar { background: #003366; }
  header.navbar.dark-mode { background: #0a0a23; }
  .navbar-brand, .navbar-brand:hover { color: #fff !important; }
  .spinner-overlay{
    position: fixed; inset:0; background: rgba(255,255,255,0.7); display:flex; align-items:center; justify-content:center; z-index:1050; display:none;
  }
  .table-responsive { max-height: 56vh; overflow:auto; }
  .small-muted { font-size: 0.85rem; color: #6c757d; }
  .pagination { justify-content: center; }
</style>
</head>
<body>

<header>
<nav class="navbar navbar-expand-lg" id="navbarMain">
<div class="container">
  <a class="navbar-brand" href="#">Application DC</a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navMenu">
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('home')">Accueil</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('tiers')">Gestion Tiers</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('import')">Import Grand Livre</a></li>
      <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('users')">Utilisateurs</a></li>
    </ul>
    <div class="dropdown ms-3">
      <button class="btn btn-outline-light dropdown-toggle d-none" id="btnLogoutMenu" data-bs-toggle="dropdown">
        <i class="bi bi-person-circle"></i> Paramètres
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="btnLogoutMenu">
        <li><a class="dropdown-item" href="#" onclick="toggleDarkMode()"><i class="bi bi-moon"></i> Mode sombre</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Déconnexion</a></li>
      </ul>
    </div>
  </div>
</div>
</nav>
</header>

<main class="container my-4">

<div id="spinner" class="spinner-overlay">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"></div>
    <div class="mt-2">Traitement en cours...</div>
  </div>
</div>

<!-- Login Section -->
<section id="loginSection" class="card p-4">
<h3>Connexion</h3>
<p class="small-muted">Identifiez-vous pour accéder à l'application.</p>
<div class="row g-2">
  <div class="col-md-5">
    <input id="username" class="form-control" placeholder="Identifiant" />
  </div>
  <div class="col-md-5">
    <input id="password" type="password" class="form-control" placeholder="Mot de passe" />
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-primary" onclick="login()"><i class="bi bi-lock-fill"></i> Se connecter</button>
  </div>
</div>
<div class="mt-2">
  <small id="loginError" class="text-danger"></small>
  <small class="d-block mt-2">Compte par défaut : <code>admin</code> / <code>dc2025</code></small>
</div>
</section>

<!-- Home Section -->
<section id="homeSection" class="card p-4 mt-4 d-none">
<h3>Bienvenue</h3>
<p>Utilisez le menu pour naviguer entre les sections.</p>
</section>

<!-- Gestion Tiers Section -->
<section id="tiersSection" class="card p-4 mt-4 d-none">
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3>Gestion des Tiers</h3>
  <button class="btn btn-sm btn-outline-secondary" onclick="showSection('home')"><i class="bi bi-arrow-left"></i> Retour</button>
</div>
<div class="row mb-2">
  <div class="col-md-6">
    <input id="searchTiers" class="form-control form-control-sm" placeholder="Rechercher..." oninput="renderTiersTable()">
  </div>
</div>
<form id="formFournisseur" class="row g-2 mt-3" onsubmit="handleTiersSubmit(event)">
<input type="hidden" id="editingIndex" />
<div class="col-md-4"><input id="inputRaison" class="form-control" placeholder="Raison Sociale (obligatoire)" required /></div>
<div class="col-md-2"><input id="inputNIF" class="form-control" placeholder="NIF (numérique)" inputmode="numeric" /></div>
<div class="col-md-3"><input id="inputStatut" class="form-control" placeholder="Statut" /></div>
<div class="col-md-3 d-flex gap-2">
  <input id="inputAdresse" class="form-control" placeholder="Adresse" />
  <button id="btnAdd" class="btn btn-success" type="submit"><i class="bi bi-plus-lg"></i> Ajouter</button>
</div>
</form>
<div class="table-responsive mt-3">
<table id="tableFournisseurs" class="table table-striped table-hover">
<thead class="table-primary">
<tr><th>Raison Sociale</th><th>NIF</th><th>Statut</th><th>Adresse</th><th style="width:140px">Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<nav>
<ul id="tiersPagination" class="pagination mt-2"></ul>
</nav>
</section>

<!-- Gestion Utilisateurs -->
<section id="usersSection" class="card p-4 mt-4 d-none">
<h3>Gestion des utilisateurs</h3>
<form id="formUser" class="row g-2 mt-2" onsubmit="handleUserSubmit(event)">
<input type="hidden" id="editingUserIndex" />
<div class="col-md-4"><input id="inputUser" class="form-control" placeholder="Nom utilisateur" required></div>
<div class="col-md-4"><input id="inputPass" type="password" class="form-control" placeholder="Mot de passe" required></div>
<div class="col-md-4 d-flex gap-2">
  <button id="btnAddUser" class="btn btn-success" type="submit"><i class="bi bi-plus-lg"></i> Ajouter</button>
</div>
</form>
<div class="table-responsive mt-3">
<table id="tableUsers" class="table table-striped table-hover">
<thead class="table-primary">
<tr><th>Utilisateur</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>

<footer class="mt-4 small text-muted">Version client-side demo (localStorage)</footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const LS_KEY = "fournisseursArray_v2";
const LS_USERS = "usersArray_v2";
let fournisseursArray = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let usersArray = JSON.parse(localStorage.getItem(LS_USERS) || '[{"username":"admin","password":"dc2025"}]');
let currentPage = 1;
const pageSize = 5;
let darkMode = false;

// --- Theme ---
function toggleDarkMode(){
  darkMode = !darkMode;
  document.body.classList.toggle("dark-mode", darkMode);
  document.getElementById("navbarMain").classList.toggle("dark-mode", darkMode);
}

// --- Login / Logout ---
function login(){
  const user=document.getElementById("username").value.trim();
  const pass=document.getElementById("password").value;
  const loginError=document.getElementById("loginError");
  loginError.textContent = "";
  const found = usersArray.find(u=>u.username===user && u.password===pass);
  if(found){
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
    document.getElementById("btnLogoutMenu").classList.remove("d-none");
    showSection("home");
  } else loginError.textContent = "Identifiants invalides.";
}

function logout(){
  showSection("login");
  document.getElementById("btnLogoutMenu").classList.add("d-none");
}

// --- Fournisseurs ---
function saveFournisseursToStorage(){ localStorage.setItem(LS_KEY, JSON.stringify(fournisseursArray)); }
function handleTiersSubmit(e){
  e.preventDefault();
  const raison=document.getElementById("inputRaison").value.trim();
  const nif=document.getElementById("inputNIF").value.trim();
  const statut=document.getElementById("inputStatut").value.trim();
  const adresse=document.getElementById("inputAdresse").value.trim();
  const editingIndex=document.getElementById("editingIndex").value;
  if(!raison){ alert("Raison sociale obligatoire."); return; }
  if(nif && !/^\d+$/.test(nif)){ alert("NIF doit contenir seulement des chiffres."); return; }
  const obj={raisonSociale:raison,nif,statut,adresse};
  if(editingIndex){ fournisseursArray[parseInt(editingIndex,10)]=obj; document.getElementById("editingIndex").value=""; document.getElementById("btnAdd").innerHTML='<i class="bi bi-plus-lg"></i> Ajouter'; }
  else fournisseursArray.push(obj);
  saveFournisseursToStorage(); currentPage=1; renderTiersTable(); document.getElementById("formFournisseur").reset();
}
function renderTiersTable(){
  const tbody=document.querySelector("#tableFournisseurs tbody");
  tbody.innerHTML="";
  const q=document.getElementById("searchTiers").value.trim().toLowerCase();
  const filtered = fournisseursArray.filter(f=>!q || (f.raisonSociale+" "+(f.nif||"")+" "+(f.statut||"")).toLowerCase().includes(q));
  const totalPages=Math.ceil(filtered.length/pageSize);
  if(currentPage>totalPages) currentPage=totalPages||1;
  const start=(currentPage-1)*pageSize;
  const end=start+pageSize;
  filtered.slice(start,end).forEach((f, idx)=>{
    const realIdx=start+idx;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(f.raisonSociale)}</td><td>${escapeHtml(f.nif||"")}</td><td>${escapeHtml(f.statut||"")}</td><td>${escapeHtml(f.adresse||"")}</td>
    <td class="text-end"><div class="btn-group" role="group"><button class="btn btn-sm btn-outline-primary" onclick="editFournisseur(${realIdx})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteFournisseur(${realIdx})"><i class="bi bi-trash"></i></button></div></td>`;
    tbody.appendChild(tr);
  });
  renderPagination(totalPages);
}
function renderPagination(totalPages){
  const ul=document.getElementById("tiersPagination"); ul.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const li=document.createElement("li"); li.className="page-item"+(i===currentPage?" active":"");
    li.innerHTML=`<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
    ul.appendChild(li);
  }
}
function changePage(page){ currentPage=page; renderTiersTable(); }
function editFournisseur(idx){
  const f=fournisseursArray[idx];
  document.getElementById("inputRaison").value=f.raisonSociale;
  document.getElementById("inputNIF").value=f.nif||"";
  document.getElementById("inputStatut").value=f.statut||"";
  document.getElementById("inputAdresse").value=f.adresse||"";
  document.getElementById("editingIndex").value=idx;
  document.getElementById("btnAdd").innerHTML='<i class="bi bi-save"></i> Enregistrer';
  window.scrollTo({top:0,behavior:'smooth'});
}
function deleteFournisseur(idx){ if(confirm("Confirmer la suppression ?")){ fournisseursArray.splice(idx,1); saveFournisseursToStorage(); renderTiersTable(); } }

// --- Utilisateurs ---
function saveUsersToStorage(){ localStorage.setItem(LS_USERS, JSON.stringify(usersArray)); }
function handleUserSubmit(e){
  e.preventDefault();
  const user=document.getElementById("inputUser").value.trim();
  const pass=document.getElementById("inputPass").value;
  const editingIndex=document.getElementById("editingUserIndex").value;
  if(editingIndex){ usersArray[parseInt(editingIndex,10)]={username:user,password:pass}; document.getElementById("editingUserIndex").value=""; document.getElementById("btnAddUser").innerHTML='<i class="bi bi-plus-lg"></i> Ajouter'; }
  else usersArray.push({username:user,password:pass});
  saveUsersToStorage(); renderUsersTable(); document.getElementById("formUser").reset();
}
function renderUsersTable(){
  const tbody=document.querySelector("#tableUsers tbody"); tbody.innerHTML="";
  usersArray.forEach((u,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${escapeHtml(u.username)}</td><td><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="editUser(${idx})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${idx})"><i class="bi bi-trash"></i></button></div></td>`;
    tbody.appendChild(tr);
  });
}
function editUser(idx){
  const u=usersArray[idx];
  document.getElementById("inputUser").value=u.username;
  document.getElementById("inputPass").value=u.password;
  document.getElementById("editingUserIndex").value=idx;
  document.getElementById("btnAddUser").innerHTML='<i class="bi bi-save"></i> Enregistrer';
}
function deleteUser(idx){ if(confirm("Confirmer la suppression ?")){ usersArray.splice(idx,1); saveUsersToStorage(); renderUsersTable(); } }

function escapeHtml(s){ if(!s && s!==0) return""; return s.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

renderTiersTable(); renderUsersTable(); showSection("login");
</script>
</body>
</html>
