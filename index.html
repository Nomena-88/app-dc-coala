<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Application DC — Gestion Tiers & Import Grand Livre</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body { background: #f4f6fb; }
  body.dark-mode { background:#1e1e2f; color:#ddd; }
  body.dark-mode .card { background:#2b2b3c; color:#ddd; }
  header.navbar { background: #003366; }
  .navbar-brand, .navbar-brand:hover { color: #fff !important; }
  .card { border-radius: 12px; }
  .spinner-overlay{
    position: fixed; inset:0; background: rgba(255,255,255,0.7); display:flex; align-items:center; justify-content:center; z-index:1050; display:none;
  }
  .table-responsive { max-height: 56vh; overflow:auto; }
  .small-muted { font-size: 0.85rem; color: #6c757d; }
</style>
</head>
<body>

<header>
<nav class="navbar navbar-expand-lg">
<div class="container">
<a class="navbar-brand" href="#">Application DC</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
  <span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navMenu">
  <ul class="navbar-nav ms-auto">
    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('home')">Accueil</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('tiers')">Gestion Tiers</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('import')">Import Grand Livre</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showSection('users')">Utilisateurs</a></li>
    <li class="nav-item"><a class="nav-link text-white" href="#" onclick="toggleDarkMode()"><i class="bi bi-moon-stars"></i></a></li>
  </ul>
  <button id="btnLogoutMenu" class="btn btn-outline-light ms-3 d-none" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Déconnexion</button>
</div>
</div>
</nav>
</header>

<main class="container my-4">

<div id="spinner" class="spinner-overlay">
<div class="text-center">
  <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem"></div>
  <div class="mt-2">Traitement en cours...</div>
</div>
</div>

<!-- Login -->
<section id="loginSection" class="card p-4">
<h3>Connexion</h3>
<p class="small-muted">Identifiez-vous pour accéder à l'application.</p>
<div class="row g-2">
  <div class="col-md-5"><input id="username" class="form-control" placeholder="Identifiant" /></div>
  <div class="col-md-5"><input id="password" type="password" class="form-control" placeholder="Mot de passe" /></div>
  <div class="col-md-2 d-grid"><button class="btn btn-primary" onclick="login()"><i class="bi bi-lock-fill"></i> Se connecter</button></div>
</div>
<div class="mt-2">
  <small id="loginError" class="text-danger"></small>
</div>
</section>

<!-- Home -->
<section id="homeSection" class="card p-4 mt-4 d-none">
<h3>Bienvenue dans l'application DC</h3>
<p>Utilisez le menu ou les boutons ci-dessous.</p>
<div class="row">
  <div class="col-md-4">
    <div class="card p-3 mb-3">
      <h5><i class="bi bi-people-fill"></i> Tiers</h5>
      <p class="small-muted">Ajouter, modifier, supprimer et rechercher des fournisseurs.</p>
      <button class="btn btn-sm btn-primary" onclick="showSection('tiers')">Aller aux tiers</button>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 mb-3">
      <h5><i class="bi bi-file-earmark-spreadsheet-fill"></i> Import Grand Livre</h5>
      <p class="small-muted">Importer CSV/Excel exporté de Coala.</p>
      <button class="btn btn-sm btn-primary" onclick="showSection('import')">Importer un fichier</button>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 mb-3">
      <h5><i class="bi bi-person-badge"></i> Utilisateurs</h5>
      <p class="small-muted">Gérer les comptes utilisateurs.</p>
      <button class="btn btn-sm btn-primary" onclick="showSection('users')">Voir utilisateurs</button>
    </div>
  </div>
</div>
</section>

<!-- Gestion Tiers -->
<section id="tiersSection" class="card p-4 mt-4 d-none">
<div class="d-flex justify-content-between align-items-center mb-2">
  <h3>Gestion des Tiers</h3>
  <button class="btn btn-sm btn-outline-secondary" onclick="showSection('home')"><i class="bi bi-arrow-left"></i> Retour</button>
</div>
<div class="row mb-2">
<div class="col-md-6"><input id="searchTiers" class="form-control form-control-sm" placeholder="Rechercher..." oninput="renderTiersTable()"></div>
</div>
<form id="formFournisseur" class="row g-2 mt-3" onsubmit="handleTiersSubmit(event)">
<input type="hidden" id="editingIndex" />
<div class="col-md-4"><input id="inputRaison" class="form-control" placeholder="Raison Sociale (obligatoire)" required /></div>
<div class="col-md-2"><input id="inputNIF" class="form-control" placeholder="NIF (numérique)" inputmode="numeric" /></div>
<div class="col-md-3"><input id="inputStatut" class="form-control" placeholder="Statut" /></div>
<div class="col-md-3 d-flex gap-2"><input id="inputAdresse" class="form-control" placeholder="Adresse" /><button id="btnAdd" class="btn btn-success" type="submit"><i class="bi bi-plus-lg"></i> Ajouter</button></div>
</form>
<div class="table-responsive mt-3">
<table id="tableFournisseurs" class="table table-striped table-hover">
<thead class="table-primary">
<tr><th>Raison Sociale</th><th>NIF</th><th>Statut</th><th>Adresse</th><th>Actions</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="mt-2 d-flex justify-content-between">
<div id="paginationTiers"></div>
</div>
</section>

<!-- Utilisateurs -->
<section id="usersSection" class="card p-4 mt-4 d-none">
<div class="d-flex justify-content-between align-items-center mb-2">
<h3>Gestion Utilisateurs</h3>
<button class="btn btn-sm btn-outline-secondary" onclick="showSection('home')"><i class="bi bi-arrow-left"></i> Retour</button>
</div>
<div class="row g-2 mb-2">
<div class="col-md-4"><input id="inputUserName" class="form-control" placeholder="Nom utilisateur" /></div>
<div class="col-md-4"><input id="inputUserPass" type="password" class="form-control" placeholder="Mot de passe" /></div>
<div class="col-md-4 d-grid"><button class="btn btn-success" onclick="addUser()"><i class="bi bi-plus-lg"></i> Ajouter utilisateur</button></div>
</div>
<div class="table-responsive">
<table id="tableUsers" class="table table-striped table-hover">
<thead class="table-primary"><tr><th>Utilisateur</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<footer class="mt-4 small text-muted">Version améliorée • Client-side demo (localStorage)</footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* LocalStorage keys */
const LS_USERS = "usersArray_v2";
const LS_TIERS = "fournisseursArray_v2";
let usersArray = JSON.parse(localStorage.getItem(LS_USERS)||"[]");
if(usersArray.length===0){usersArray=[{username:"admin",password:"dc2025"}]; localStorage.setItem(LS_USERS,JSON.stringify(usersArray));}
let fournisseursArray = JSON.parse(localStorage.getItem(LS_TIERS)||"[]");

/* Mode sombre */
let darkMode=false;
function toggleDarkMode(){ darkMode=!darkMode; document.body.classList.toggle("dark-mode"); }

/* Login / Logout */
function login(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value;
  const found=usersArray.find(user=>user.username===u && user.password===p);
  if(found){ document.getElementById("username").value=""; document.getElementById("password").value=""; document.getElementById("btnLogoutMenu").classList.remove("d-none"); showSection("home"); }
  else document.getElementById("loginError").textContent="Identifiants invalides.";
}
function logout(){ showSection("login"); }

/* Section toggle */
function showSection(name){
  ["loginSection","homeSection","tiersSection","importSectionCard","usersSection"].forEach(s=>document.getElementById(s)?.classList.add("d-none"));
  if(name!=="login") document.getElementById("btnLogoutMenu").classList.remove("d-none");
  document.getElementById(name+"Section")?.classList.remove("d-none");
  if(name==="tiers") renderTiersTable();
  if(name==="users") renderUsersTable();
}

/* Gestion Tiers */
function saveTiers(){ localStorage.setItem(LS_TIERS,JSON.stringify(fournisseursArray)); }
function handleTiersSubmit(e){ e.preventDefault(); const raison=document.getElementById("inputRaison").value.trim(); const nif=document.getElementById("inputNIF").value.trim(); const statut=document.getElementById("inputStatut").value.trim(); const adresse=document.getElementById("inputAdresse").value.trim(); const idx=document.getElementById("editingIndex").value;
if(!raison){alert("Raison sociale obligatoire."); return;} if(nif && !/^\d+$/.test(nif)){alert("NIF doit contenir seulement des chiffres."); return;}
const obj={raisonSociale:raison,nif,statut,adresse};
if(idx){ fournisseursArray[parseInt(idx,10)]=obj; document.getElementById("editingIndex").value=""; document.getElementById("btnAdd").innerHTML='<i class="bi bi-plus-lg"></i> Ajouter'; }
else fournisseursArray.push(obj);
saveTiers(); renderTiersTable(); document.getElementById("formFournisseur").reset(); }

/* Pagination pour Tiers */
let currentPage=1, itemsPerPage=5;
function renderTiersTable(){
  const tbody=document.querySelector("#tableFournisseurs tbody"); tbody.innerHTML="";
  const q=document.getElementById("searchTiers").value.trim().toLowerCase();
  let filtered=fournisseursArray.filter(f=> (f.raisonSociale+" "+(f.nif||"")+" "+(f.statut||"")).toLowerCase().includes(q));
  const totalPages=Math.ceil(filtered.length/itemsPerPage);
  currentPage=Math.min(currentPage,totalPages)||1;
  const start=(currentPage-1)*itemsPerPage;
  const pageItems=filtered.slice(start,start+itemsPerPage);
  pageItems.forEach((f,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${f.raisonSociale}</td><td>${f.nif||""}</td><td>${f.statut||""}</td><td>${f.adresse||""}</td>
    <td><div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="editTiers(${start+idx})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteTiers(${start+idx})"><i class="bi bi-trash"></i></button></div></td>`;
    tbody.appendChild(tr);
  });
  renderPagination(totalPages);
}
function editTiers(idx){ const f=fournisseursArray[idx]; document.getElementById("inputRaison").value=f.raisonSociale; document.getElementById("inputNIF").value=f.nif||""; document.getElementById("inputStatut").value=f.statut||""; document.getElementById("inputAdresse").value=f.adresse||""; document.getElementById("editingIndex").value=idx; document.getElementById("btnAdd").innerHTML='<i class="bi bi-save"></i> Enregistrer'; }
function deleteTiers(idx){ if(confirm("Confirmer la suppression ?")){ fournisseursArray.splice(idx,1); saveTiers(); renderTiersTable(); } }
function renderPagination(totalPages){
  const container=document.getElementById("paginationTiers"); container.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button"); btn.className=`btn btn-sm ${i===currentPage?"btn-primary":"btn-outline-primary"} me-1`; btn.textContent=i; btn.onclick=()=>{currentPage=i; renderTiersTable();};
    container.appendChild(btn);
  }
}

/* Gestion utilisateurs */
function saveUsers(){ localStorage.setItem(LS_USERS,JSON.stringify(usersArray)); }
function addUser(){ const u=document.getElementById("inputUserName").value.trim(); const p=document.getElementById("inputUserPass").value; if(!u||!p){alert("Remplir les deux champs."); return;} usersArray.push({username:u,password:p}); saveUsers(); renderUsersTable(); document.getElementById("inputUserName").value=""; document.getElementById("inputUserPass").value=""; }
function renderUsersTable(){ const tbody=document.querySelector("#tableUsers tbody"); tbody.innerHTML=""; usersArray.forEach((u,idx)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${u.username}</td><td><button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${idx})"><i class="bi bi-trash"></i></button></td>`; tbody.appendChild(tr); }); }
function deleteUser(idx){ if(confirm("Supprimer cet utilisateur ?")){ usersArray.splice(idx,1); saveUsers(); renderUsersTable(); } }

showSection("login");
</script>
</body>
</html>
