<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<script>
  function processFile() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) {
      alert("Veuillez importer un fichier CSV ou Excel exporté de Coala.");
      return;
    }

    const reader = new FileReader();

    function processData(lines, header) {
      const idxCompte = header.findIndex(h => h.toLowerCase().includes("compte"));
      const idxTiers = header.findIndex(h => h.toLowerCase().includes("tiers"));
      const idxNif = header.findIndex(h => h.toLowerCase().includes("nif"));
      const idxDebit = header.findIndex(h => h.toLowerCase().includes("debit"));
      const idxCredit = header.findIndex(h => h.toLowerCase().includes("credit"));

      if (idxCompte === -1 || idxTiers === -1 || idxNif === -1 || idxDebit === -1 || idxCredit === -1) {
        alert("Le fichier doit contenir les colonnes suivantes : Compte, Tiers, NIF, Débit, Crédit.");
        return;
      }

      const data = {};
      lines.forEach(cols => {
        if (cols.length < header.length) return;

        const compte = (cols[idxCompte] || "").toString().trim();
        if (!compte.startsWith("6")) return; // Filtrage : uniquement classe 6

        const tiers = (cols[idxTiers] || "Inconnu").trim();
        const nif = (cols[idxNif] || "-").trim();
        const debit = parseFloat((cols[idxDebit] || "0").toString().replace(",", ".")) || 0;
        const credit = parseFloat((cols[idxCredit] || "0").toString().replace(",", ".")) || 0;

        const key = tiers + "|" + nif;
        if (!data[key]) data[key] = { fournisseur: tiers, nif, total: 0 };
        data[key].total += debit - credit;
      });

      renderTable(data);
    }

    if (file.name.endsWith(".csv")) {
      reader.onload = function (e) {
        const lines = e.target.result.split("\n").map(l => l.trim()).filter(l => l.length);
        const header = lines[0].split(",");
        const rows = lines.slice(1).map(line => line.split(","));
        processData(rows, header);
      };
      reader.readAsText(file);
    } else if (file.name.endsWith(".xlsx")) {
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        const header = json[0];
        const rows = json.slice(1);
        processData(rows, header);
      };
      reader.readAsArrayBuffer(file);
    } else {
      alert("Format de fichier non supporté, veuillez importer un fichier CSV ou Excel (.xlsx).");
    }
  }

  function renderTable(data) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";
    Object.values(data).forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.fournisseur}</td>
        <td>${row.nif}</td>
        <td>${row.total.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("results").classList.remove("hidden");
  }
</script>
